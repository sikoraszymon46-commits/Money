<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot, updateDoc, doc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCVkqjA4Yw_cAyKJ5wZ_YojZmEsa_w3THs",
  authDomain: "money-19005.firebaseapp.com",
  projectId: "money-19005"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.load = function(status){
  const q=query(collection(db,"withdrawals"),where("status","==",status));
  onSnapshot(q,(snap)=>{
    const box=document.getElementById("w");
    box.innerHTML="";
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      box.innerHTML+=`
      <div class="card">
      ${d.name}<br>
      ${d.paypal}<br>
      ${d.amount} zł<br>
      <button onclick="update('${docSnap.id}','w trakcie realizowania')">W trakcie</button>
      <button onclick="update('${docSnap.id}','wysłane')">Wyślij</button>
      <button onclick="update('${docSnap.id}','odrzucone')">Odrzuć</button>
      </div>`;
    });
  });
}

window.update=async function(id,status){
  const ref=doc(db,"withdrawals",id);
  const snap=await getDoc(ref);
  const data=snap.data();

  if(status==="wysłane" && data.status!=="wysłane"){
    const userRef=doc(db,"users",data.userId);
    const userSnap=await getDoc(userRef);
    const userData=userSnap.data();
    await updateDoc(userRef,{
      points:userData.points-data.pointsUsed,
      withdrawalsCount:(userData.withdrawalsCount||0)+1
    });
  }

  await updateDoc(ref,{status:status});
}

// Ranking
onSnapshot(query(collection(db,"users"),orderBy("points","desc")),(snap)=>{
  const box=document.getElementById("ranking");
  box.innerHTML="";
  let i=1;
  snap.forEach(doc=>{
    const d=doc.data();
    box.innerHTML+=`
    <div class="card">
    #${i} ${d.name}<br>
    Punkty: ${d.points}<br>
    Rebirth: ${d.rebirths}<br>
    Wypłaty: ${d.withdrawalsCount||0}
    </div>`;
    i++;
  });
});
</script>

<style>
body{background:#111;color:white;text-align:center;font-family:Arial}
.card{background:#1e1e1e;margin:10px;padding:15px;border-radius:10px}
button{background:#00ffcc;border:none;padding:8px;margin:5px;border-radius:6px}
</style>
</head>
<body>

<h1>Admin Panel</h1>

<button onclick="load('oczekujące')">Oczekujące</button>
<button onclick="load('w trakcie realizowania')">W trakcie</button>
<button onclick="load('wysłane')">Wysłane</button>
<button onclick="load('odrzucone')">Odrzucone</button>

<div id="w"></div>

<h2>Ranking</h2>
<div id="ranking"></div>

</body>
</html>